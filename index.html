<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Script-to-Shot Wizard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Turn scripts into production-ready shot lists with AI." />

    <!-- Styles (simple, tweak as you like) -->
    <style>
      :root { --maxw: 960px; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; color:#222; }
      header { padding: 56px 20px; background: #f7f7f7; }
      .wrap { max-width: var(--maxw); margin: 0 auto; padding: 0 16px; }
      h1 { font-size: 40px; margin: 0 0 12px; }
      p.lead { color:#444; margin: 0 auto 20px; max-width: 720px; line-height: 1.6; }
      nav a { margin-right: 12px; color:#222; text-decoration:none; }
      .cta { display:inline-block; padding:10px 16px; border:1px solid #222; border-radius:8px; text-decoration:none; color:#222; }
      footer { padding: 24px; text-align:center; color:#777; border-top:1px solid #eee; margin-top: 56px; }
      #fallback { display:none; padding: 12px; text-align:center; color:#777; }
    </style>

    <!-- Netlify Identity widget (required for login/invites) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- Markdown renderer for CMS content -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <header>
      <div class="wrap">
        <h1>Script-to-Shot Wizard</h1>
        <p class="lead">Turn scripts into production-ready shot lists with AI.</p>
        <a class="cta" href="#contact">Contact</a>
      </div>
    </header>

    <div class="wrap">
      <nav id="nav"></nav>
      <main id="cms-body">
        <div id="fallback">Loading content…</div>
        <!-- CMS Markdown will be injected here -->
      </main>
      <section id="contact" class="wrap">
        <h2>Contact</h2>
        <p>Email: hello@example.com</p>
      </section>
    </div>

    <footer>© <span id="y"></span> Script-to-Shot Wizard</footer>

    <script>
      // Year
      document.getElementById('y').textContent = new Date().getFullYear();

      // ---- Handle Netlify Identity invite links (PERMANENT FIX) ----
      // If the email link opens the homepage with #invite_token, complete signup here.
      (function handleInvite() {
        if (!location.hash.includes('invite_token')) return;
        if (!window.netlifyIdentity) return;
        // Accept invite -> Netlify Identity will show the password setup if needed
        window.netlifyIdentity.acceptInvite();
        // After login, take the user to /admin
        window.netlifyIdentity.on('login', () => { location.href = '/admin/'; });
        // Optional: if user cancels, clean the hash
        window.netlifyIdentity.on('error', () => { history.replaceState(null, '', location.pathname); });
      })();

      // ---- Optional: add a small login helper (person icon usually shows automatically) ----
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', user => {
          // You could show/hide custom login/logout buttons here if you add them later.
        });
      }

      // ---- Load editable content from /content ----

      // Load SEO (updates <title> and <meta description> if present)
      fetch('/content/settings/seo.json')
        .then(r => r.ok ? r.json() : null)
        .then(seo => {
          if (!seo) return;
          if (seo.siteName) document.title = seo.siteName;
          if (seo.description) {
            let m = document.querySelector('meta[name="description"]');
            if (!m) { m = document.createElement('meta'); m.name = 'description'; document.head.appendChild(m); }
            m.content = seo.description;
          }
        }).catch(()=>{});

      // Load navigation
      fetch('/content/settings/navigation.json')
        .then(r => r.ok ? r.json() : { items: [] })
        .then(nav => {
          const el = document.getElementById('nav');
          if (!el || !nav.items) return;
          el.innerHTML = nav.items.map(i => `<a href="${i.href}">${i.label}</a>`).join('');
        }).catch(()=>{});

      // Load homepage Markdown and render it
      fetch('/content/pages/home.md')
        .then(r => r.ok ? r.text() : '')
        .then(text => {
          const container = document.getElementById('cms-body');
          const fb = document.getElementById('fallback');
          if (fb) fb.style.display = 'block';
          if (!text) { container.insertAdjacentHTML('beforeend', '<p>No content yet.</p>'); return; }
          // Strip frontmatter (--- ... ---)
          const body = text.replace(/^---[\s\S]*?---\s*/, '');
          const html = marked.parse(body);
          if (fb) fb.style.display = 'none';
          container.insertAdjacentHTML('beforeend', html);
        }).catch(()=>{
          const fb = document.getElementById('fallback');
          if (fb) fb.textContent = 'Could not load content.';
        });
    </script>
  </body>
</html>
